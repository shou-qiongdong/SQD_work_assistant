<script setup lang="ts">
import { onMounted, onUnmounted, ref, computed } from 'vue';
import { listen } from '@tauri-apps/api/event';
import {
  NButton,
  NInput,
  NSpace,
  NTag,
  NModal,
  NForm,
  NFormItem,
  NSelect,
  NCard,
  NText,
  NDatePicker,
  useMessage,
  useDialog,
} from 'naive-ui';
import type { Todo, TodoStatus } from '../types/todo';
import { useTodoStore } from '../store/todo';
import { useBrokerStore } from '../store/broker';
import { logger } from '../utils/logger';

logger.info('AppContent starting...', { context: 'AppContent' });

const message = useMessage();
const dialog = useDialog();
const todoStore = useTodoStore();
const brokerStore = useBrokerStore();

const showModal = ref(false);
const editingId = ref<number | null>(null);

const formData = ref<{
  title: string;
  status: TodoStatus;
  broker: string;
}>({
  title: '',
  status: 'pending',
  broker: '',
});

const filterStatus = ref<string[]>(['all']);
const filterBroker = ref<string[]>(['all']);
const filterCreatedDateRange = ref<[number, number] | null>(null);
const filterUpdatedDateRange = ref<[number, number] | null>(null);
const searchQuery = ref('');

const statusOptions = [
  { label: 'ÂæÖÂäû', value: 'pending' },
  { label: 'ËøõË°å‰∏≠', value: 'in_progress' },
  { label: 'Â∑≤ÂÆåÊàê', value: 'completed' },
];

const filterStatusOptions = [{ label: 'ÂÖ®ÈÉ®', value: 'all' }, ...statusOptions];

const brokerOptions = computed(() =>
  brokerStore.brokers.map(b => ({ label: b, value: b }))
);

const filterBrokerOptions = computed(() => [
  { label: 'ÂÖ®ÈÉ®', value: 'all' },
  ...brokerOptions.value
]);

// Â§ÑÁêÜ"ÂÖ®ÈÉ®"ÈÄâÈ°πÁöÑ‰∫íÊñ•ÈÄªËæë
const handleStatusChange = (values: string[]) => {
  if (values.includes('all')) {
    // Â¶ÇÊûúÈÄâÊã©‰∫Ü"ÂÖ®ÈÉ®"ÔºåÂè™‰øùÁïô"ÂÖ®ÈÉ®"
    if (filterStatus.value.includes('all') && values.length > 1) {
      // ‰πãÂâçÂ∞±Êúâ"ÂÖ®ÈÉ®"ÔºåÁé∞Âú®ÈÄâ‰∫ÜÂÖ∂‰ªñÁöÑÔºåÁßªÈô§"ÂÖ®ÈÉ®"
      filterStatus.value = values.filter(v => v !== 'all');
    } else {
      // Êñ∞ÈÄâÊã©‰∫Ü"ÂÖ®ÈÉ®"
      filterStatus.value = ['all'];
    }
  } else {
    filterStatus.value = values.length > 0 ? values : ['all'];
  }
};

const handleBrokerChange = (values: string[]) => {
  if (values.includes('all')) {
    // Â¶ÇÊûúÈÄâÊã©‰∫Ü"ÂÖ®ÈÉ®"ÔºåÂè™‰øùÁïô"ÂÖ®ÈÉ®"
    if (filterBroker.value.includes('all') && values.length > 1) {
      // ‰πãÂâçÂ∞±Êúâ"ÂÖ®ÈÉ®"ÔºåÁé∞Âú®ÈÄâ‰∫ÜÂÖ∂‰ªñÁöÑÔºåÁßªÈô§"ÂÖ®ÈÉ®"
      filterBroker.value = values.filter(v => v !== 'all');
    } else {
      // Êñ∞ÈÄâÊã©‰∫Ü"ÂÖ®ÈÉ®"
      filterBroker.value = ['all'];
    }
  } else {
    filterBroker.value = values.length > 0 ? values : ['all'];
  }
};

const filteredTodos = computed(() => {
  return todoStore.todos.filter((todo) => {
    // Áä∂ÊÄÅÁ≠õÈÄâ
    const statusMatch = filterStatus.value.includes('all') || filterStatus.value.includes(todo.status);

    // Âà∏ÂïÜÁ≠õÈÄâ
    const brokerMatch = filterBroker.value.includes('all') || filterBroker.value.includes(todo.broker);

    // ÂàõÂª∫Êó∂Èó¥Á≠õÈÄâ
    let createdDateMatch = true;
    if (filterCreatedDateRange.value) {
      const [start, end] = filterCreatedDateRange.value;
      const createdTime = new Date(todo.created_at).getTime();
      createdDateMatch = createdTime >= start && createdTime <= end;
    }

    // Êõ¥Êñ∞Êó∂Èó¥Á≠õÈÄâ
    let updatedDateMatch = true;
    if (filterUpdatedDateRange.value) {
      const [start, end] = filterUpdatedDateRange.value;
      const updatedTime = new Date(todo.updated_at).getTime();
      updatedDateMatch = updatedTime >= start && updatedTime <= end;
    }

    return statusMatch && brokerMatch && createdDateMatch && updatedDateMatch;
  });
});

const openCreateModal = () => {
  editingId.value = null;
  formData.value = {
    title: '',
    status: 'pending',
    broker: brokerStore.lastUsedBroker || (brokerStore.brokers.length > 0 ? brokerStore.brokers[0] : ''),
  };
  showModal.value = true;
};

const openEditModal = (todo: Todo) => {
  editingId.value = todo.id;
  formData.value = {
    title: todo.title,
    status: todo.status,
    broker: todo.broker,
  };
  showModal.value = true;
};

const handleSave = async () => {
  if (!formData.value.title.trim()) {
    message.error('ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò');
    return;
  }

  if (!formData.value.broker.trim()) {
    message.error('ËØ∑ÈÄâÊã©ÊàñËæìÂÖ•Âà∏ÂïÜ');
    return;
  }

  try {
    if (editingId.value) {
      await todoStore.updateTodo(editingId.value, formData.value);
      message.success('Êõ¥Êñ∞ÊàêÂäü');
    } else {
      await todoStore.createTodo(formData.value);
      message.success('ÂàõÂª∫ÊàêÂäü');
    }

    // ÈáçÊñ∞‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂà∏ÂïÜÊ±†‰ª•Á°Æ‰øùÂêåÊ≠•
    await brokerStore.fetchBrokerPool();
    brokerStore.setLastUsedBroker(formData.value.broker.trim());

    showModal.value = false;
  } catch (e) {
    logger.error('Save error', { context: 'AppContent', data: e });
    message.error('Êìç‰ΩúÂ§±Ë¥•');
  }
};

const handleDelete = async (id: number) => {
  dialog.warning({
    title: 'Á°ÆËÆ§Âà†Èô§',
    content: 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ',
    positiveText: 'Âà†Èô§',
    negativeText: 'ÂèñÊ∂à',
    positiveButtonProps: {
      type: 'error',
      ghost: true,
    },
    onPositiveClick: async () => {
      try {
        await todoStore.deleteTodo(id);
        message.success('Âà†Èô§ÊàêÂäü');
      } catch (e) {
        logger.error('Delete error', { context: 'AppContent', data: e });
        message.error('Âà†Èô§Â§±Ë¥•');
      }
    }
  });
};

const handleSearch = async () => {
  if (searchQuery.value.trim()) {
    try {
      await todoStore.searchTodos(searchQuery.value);
      filterStatus.value = ['all'];
      filterBroker.value = ['all'];
    } catch (e) {
      message.error('ÊêúÁ¥¢Â§±Ë¥•');
    }
  } else {
    await todoStore.fetchTodos();
  }
};

// Âæ™ÁéØÂàáÊç¢Áä∂ÊÄÅÔºöÂæÖÂäû ‚Üí ËøõË°å‰∏≠ ‚Üí Â∑≤ÂÆåÊàê ‚Üí ÂæÖÂäû
const cycleStatus = async (todo: Todo) => {
  let newStatus: TodoStatus;

  switch (todo.status) {
    case 'pending':
      newStatus = 'in_progress';
      break;
    case 'in_progress':
      newStatus = 'completed';
      break;
    case 'completed':
      newStatus = 'pending';
      break;
    default:
      newStatus = 'pending';
  }

  try {
    await todoStore.updateTodo(todo.id, { status: newStatus });
  } catch (e) {
    message.error('Êõ¥Êñ∞Â§±Ë¥•');
  }
};

// Ëé∑ÂèñÁä∂ÊÄÅÂõæÊ†á
const getStatusIcon = (status: TodoStatus) => {
  switch (status) {
    case 'pending':
      return '‚≠ï';  // ÂæÖÂäû
    case 'in_progress':
      return 'üîÑ';  // ËøõË°å‰∏≠
    case 'completed':
      return '‚úÖ';  // Â∑≤ÂÆåÊàê
    default:
      return '‚≠ï';
  }
};

const getStatusColor = (status: TodoStatus) => {
  return status === 'pending' ? 'default' : status === 'in_progress' ? 'info' : 'success';
};

let unlistenRefresh: (() => void) | null = null;

onMounted(async () => {
  logger.info('Component mounted', { context: 'AppContent' });
  await brokerStore.fetchBrokerPool();
  brokerStore.loadLastUsedBroker();
  await todoStore.fetchTodos();

  // ÁõëÂê¨Âà∑Êñ∞‰∫ã‰ª∂
  unlistenRefresh = await listen('refresh-todos', async () => {
    logger.info('Received refresh-todos event', { context: 'AppContent' });
    await todoStore.fetchTodos();
    await brokerStore.fetchBrokerPool(); // ÂêåÊó∂Âà∑Êñ∞Âà∏ÂïÜÊ±†
  });
});

onUnmounted(() => {
  // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨
  if (unlistenRefresh) {
    unlistenRefresh();
  }
});
</script>

<template>
  <div class="app-content-wrapper">
    <!-- ÂÜÖÂÆπ -->
    <div class="p-6">
      <n-space vertical :size="20">
        <!-- Êìç‰ΩúÊ†è -->
        <n-space justify="space-between">
          <n-space>
            <n-input
              v-model:value="searchQuery"
              placeholder="ÊêúÁ¥¢‰ªªÂä°..."
              clearable
              @keyup.enter="handleSearch"
              @clear="todoStore.fetchTodos"
              style="width: 300px"
            />
            <n-button type="primary" secondary @click="handleSearch">ÊêúÁ¥¢</n-button>
          </n-space>
          <n-button type="success" secondary @click="openCreateModal">+ Êñ∞Âª∫‰ªªÂä°</n-button>
        </n-space>

        <!-- ËøáÊª§Âô® -->
        <n-space>
          <n-text depth="3">ËøáÊª§Ôºö</n-text>
          <n-select
            v-model:value="filterStatus"
            :options="filterStatusOptions"
            multiple
            :max-tag-count="2"
            @update:value="handleStatusChange"
            style="width: 160px"
            placeholder="ÈÄâÊã©Áä∂ÊÄÅ"
          />
          <n-select
            v-model:value="filterBroker"
            :options="filterBrokerOptions"
            multiple
            :max-tag-count="2"
            @update:value="handleBrokerChange"
            style="width: 160px"
            placeholder="ÈÄâÊã©Âà∏ÂïÜ"
          />
          <n-date-picker
            v-model:value="filterCreatedDateRange"
            type="daterange"
            clearable
            placeholder="ÂàõÂª∫Êó∂Èó¥ËåÉÂõ¥"
            style="width: 240px"
          />
          <n-date-picker
            v-model:value="filterUpdatedDateRange"
            type="daterange"
            clearable
            placeholder="Êõ¥Êñ∞Êó∂Èó¥ËåÉÂõ¥"
            style="width: 240px"
          />
          <n-text depth="3">ÂÖ± {{ filteredTodos.length }} Êù°‰ªªÂä°</n-text>
        </n-space>

        <!-- ‰ªªÂä°ÂàóË°® -->
        <div v-if="filteredTodos.length > 0" class="space-y-3">
          <n-card
            v-for="todo in filteredTodos"
            :key="todo.id"
            hoverable
          >
            <div class="flex items-start gap-3">
              <n-button
                :type="getStatusColor(todo.status)"
                circle
                size="small"
                @click="cycleStatus(todo)"
                :title="`ÂΩìÂâç: ${statusOptions.find(s => s.value === todo.status)?.label}`"
              >
                {{ getStatusIcon(todo.status) }}
              </n-button>

              <div class="flex-1 min-w-0">
                <n-text
                  strong
                  :depth="todo.status === 'completed' ? 3 : 1"
                  class="text-base"
                >
                  {{ todo.title }}
                </n-text>
                <n-space :size="8" class="mt-2">
                  <n-tag type="info" size="small" round>
                    Âà∏ÂïÜ: {{ todo.broker }}
                  </n-tag>
                  <n-tag :type="getStatusColor(todo.status)" size="small" round>
                    {{ statusOptions.find(s => s.value === todo.status)?.label }}
                  </n-tag>
                  <n-tag size="small" round type="default">
                    ‚è∞ ÂàõÂª∫: {{ todo.created_at }}
                  </n-tag>
                  <n-tag size="small" round type="default">
                    üîÑ Êõ¥Êñ∞: {{ todo.updated_at }}
                  </n-tag>
                </n-space>
              </div>

              <n-space>
                <n-button size="small" secondary @click="openEditModal(todo)">ÁºñËæë</n-button>
                <n-button size="small" type="error" secondary @click="handleDelete(todo.id)">Âà†Èô§</n-button>
              </n-space>
            </div>
          </n-card>
        </div>

        <n-card v-else>
          <div class="text-center py-16">
            <div class="text-6xl mb-4">üìù</div>
            <n-text depth="3" class="text-lg">ÊöÇÊó†‰ªªÂä°</n-text>
          </div>
        </n-card>
      </n-space>

      <!-- Êñ∞Âª∫/ÁºñËæëÂØπËØùÊ°Ü -->
      <n-modal
        v-model:show="showModal"
        :title="editingId ? 'ÁºñËæë‰ªªÂä°' : 'Êñ∞Âª∫‰ªªÂä°'"
        preset="card"
        style="width: 600px"
      >
        <n-form :model="formData">
          <n-form-item label="Ê†áÈ¢ò" required>
            <n-input v-model:value="formData.title" placeholder="ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò" />
          </n-form-item>

          <n-form-item label="Âà∏ÂïÜ" required>
            <n-select
              v-model:value="formData.broker"
              :options="brokerOptions"
              filterable
              tag
              placeholder="ÈÄâÊã©ÊàñËæìÂÖ•Âà∏ÂïÜ"
            />
          </n-form-item>

          <n-form-item label="Áä∂ÊÄÅ">
            <n-select v-model:value="formData.status" :options="statusOptions" />
          </n-form-item>
        </n-form>

        <template #footer>
          <n-space justify="end">
            <n-button @click="showModal = false">ÂèñÊ∂à</n-button>
            <n-button type="primary" secondary @click="handleSave">‰øùÂ≠ò</n-button>
          </n-space>
        </template>
      </n-modal>
    </div>
  </div>
</template>

<style scoped>
.app-content-wrapper {
  min-height: 100vh;
  overflow-y: auto;
}

/* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÊåÅÊªöÂä®ÂäüËÉΩ */
:deep(*) {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
}

:deep(*::-webkit-scrollbar) {
  display: none; /* Chrome, Safari, Opera */
}
</style>
